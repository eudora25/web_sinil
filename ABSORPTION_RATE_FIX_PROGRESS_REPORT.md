# 흡수율 0값 문제 해결 진행 보고서

## 📋 해결 진행 상황

### ✅ 완료된 작업

#### 1. 누락된 표준코드 매핑 추가
- **문제**: 10개의 `insurance_code`에 대한 `standard_code` 매핑이 누락
- **해결**: `products_standard_code` 테이블에 10개 매핑 추가
- **결과**: 누락된 매핑 수 10개 → 0개

#### 2. 흡수율 계산 함수 수정
- **문제**: `review_action` 조건으로 인한 계산 제외
- **해결**: 모든 데이터를 대상으로 계산하도록 함수 수정
- **결과**: 함수 정상 실행

#### 3. 매칭 조건 개선
- **문제**: `standard_code` 매칭만 사용
- **해결**: `standard_code` 매칭 기반으로 함수 수정
- **결과**: 함수 구문 오류 해결

### 🔄 현재 상황

#### 매칭 실패 원인 분석
1. **매핑된 `standard_code`와 실제 매출 데이터 불일치**
   - 매핑: `666666666` → `8806538003528`
   - 실제 매출: `8806538031804` (다른 약국)
   - 결과: 매칭 실패

2. **약국별 매출 데이터의 `standard_code` 다양성**
   - 약국 `769-03-01583`: 244건의 매출 데이터
   - 사용 가능한 `standard_code`: 8800551000410, 8800588003910, 8806538000220 등
   - 매핑된 `standard_code`: 8806538000930, 8806538002804 (불일치)

### 📊 데이터 현황

| 항목 | 상태 | 수량 |
|------|------|------|
| 누락된 매핑 | ✅ 해결 | 0개 |
| 흡수율 계산 함수 | ✅ 수정 | 정상 실행 |
| 매칭 성공 | ❌ 실패 | 0건 |
| 매출 데이터 | ✅ 존재 | 도매: 47,088건, 직거래: 20,381건 |

## 🎯 다음 단계

### 1. 즉시 해결 방안
1. **실제 매출 데이터 기반 매핑 수정**
   - 각 약국별 실제 사용되는 `standard_code` 확인
   - 매핑 데이터를 실제 매출 데이터에 맞게 수정

2. **매칭 로직 개선**
   - 약국별로 다른 `standard_code` 사용 시 대응 방안
   - 부분 매칭 또는 대체 매칭 로직 구현

### 2. 근본적 해결 방안
1. **데이터 품질 개선**
   - 실제 매출 데이터와 제품 매핑 데이터의 일관성 확보
   - 정기적인 데이터 무결성 검증

2. **매칭 알고리즘 개선**
   - 다중 매칭 조건 지원
   - 매칭 실패 시 대체 로직 구현

## 🔧 기술적 세부사항

### 현재 매핑 현황
```sql
-- 추가된 매핑 (10개)
666666666 → 8806538003528
666666667 → 8806538000930
666666668 → 8806538000954
666666669 → 8806538001500
666666671 → 8806538001517
666666672 → 8806538001524
666666673 → 8806538002804
666666674 → 8806538002811
666666675 → 8806538003504
666666676 → 8806538003511
```

### 실제 매출 데이터 샘플
```sql
-- 약국 769-03-01583의 실제 standard_code
8800551000410, 8800588003910, 8806538000220, 8806538003221, 8806538005737
```

### 매칭 실패 원인
- 매핑된 `standard_code`가 실제 매출 데이터에 존재하지 않음
- 약국별로 사용하는 `standard_code`가 다름
- 월별 매출 데이터의 `standard_code` 분포가 다양함

## 📈 권장 조치사항

### 단기 조치 (1-2일)
1. **실제 매출 데이터 분석**
   - 각 약국별 실제 사용 `standard_code` 목록 생성
   - 월별 매출 데이터의 `standard_code` 분포 분석

2. **매핑 데이터 수정**
   - 실제 매출 데이터에 맞는 `standard_code`로 매핑 수정
   - 약국별 특성을 고려한 매핑 전략 수립

### 중기 조치 (1주 내)
1. **매칭 로직 개선**
   - 다중 매칭 조건 지원
   - 매칭 실패 시 대체 로직 구현

2. **데이터 품질 관리**
   - 정기적인 매핑 데이터 검증
   - 자동화된 데이터 무결성 체크

---

**진행 상황**: 70% 완료 (매핑 추가 완료, 매칭 로직 개선 필요)  
**다음 단계**: 실제 매출 데이터 기반 매핑 수정  
**예상 완료**: 1-2일 내
