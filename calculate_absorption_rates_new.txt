DECLARE
    result_record RECORD;
BEGIN
    SET statement_timeout = '10min';
    
    UPDATE performance_records_absorption
    SET
        wholesale_revenue = 0,
        direct_revenue = 0,
        total_revenue = 0,
        absorption_rate = 0
    WHERE settlement_month = p_settlement_month;

    WITH
        based_prescription_month AS (
            SELECT DISTINCT rs.prescription_month
            FROM performance_records rs
            WHERE rs.settlement_month = p_settlement_month
        ),
        based_external_sales AS (
            SELECT
                sales.sales_date,
                sales.pharmacy_biz_reg_no,
                psc.insurance_code,
                ROUND(SUM(COALESCE(sales.direct_amount, 0))::NUMERIC, 2) AS total_directsale_amount,
                ROUND(SUM(COALESCE(sales.wholesale_amount, 0))::NUMERIC, 2) AS total_wholesale_amount,
                ROUND(SUM(COALESCE(sales.direct_amount, 0) + COALESCE(sales.wholesale_amount, 0))::NUMERIC, 2) AS total_sale_amount
            FROM (
                SELECT
                    TO_CHAR(ws.sales_date, 'YYYY-MM') AS sales_date,
                    ws.business_registration_number AS pharmacy_biz_reg_no,
                    ws.standard_code,
                    0::NUMERIC AS direct_amount,
                    COALESCE(ws.sales_amount, 0)::NUMERIC AS wholesale_amount
                FROM wholesale_sales ws
                WHERE TO_CHAR(ws.sales_date, 'YYYY-MM') IN (SELECT prescription_month FROM based_prescription_month)
                UNION ALL
                SELECT
                    TO_CHAR(ds.sales_date, 'YYYY-MM') AS sales_date,
                    ds.business_registration_number AS pharmacy_biz_reg_no,
                    ds.standard_code,
                    COALESCE(ds.sales_amount, 0)::NUMERIC AS direct_amount,
                    0::NUMERIC AS wholesale_amount
                FROM direct_sales ds
                WHERE TO_CHAR(ds.sales_date, 'YYYY-MM') IN (SELECT prescription_month FROM based_prescription_month)
            ) AS sales
            INNER JOIN products_standard_code psc ON psc.standard_code = sales.standard_code
            GROUP BY sales.sales_date, sales.pharmacy_biz_reg_no, psc.insurance_code
        ),
        based_pharmacy_prescription AS (
            SELECT
                pr.prescription_month,
                cpa.pharmacy_id,
                pr.product_id,
                p.insurance_code,
                SUM(COALESCE(pr.prescription_qty, 0)) AS total_prescription_qty,
                ROUND(SUM(COALESCE(pr.prescription_qty * p.price, 0))::NUMERIC, 2) AS total_prescription_amount
            FROM performance_records_absorption pr
            INNER JOIN products p ON p.id = pr.product_id
            INNER JOIN client_pharmacy_assignments cpa ON cpa.client_id = pr.client_id
            WHERE pr.prescription_month IN (SELECT prescription_month FROM based_prescription_month)
            GROUP BY pr.prescription_month, cpa.pharmacy_id, pr.product_id, p.insurance_code
        ),
        calculated_results AS (
            SELECT
                pr.id,
                ROUND(SUM(
                    CASE
                        WHEN COALESCE(bpp.total_prescription_amount, 0) = 0 THEN 0
                        ELSE (COALESCE(pr.prescription_qty * p.price, 0)::NUMERIC(18, 6)
                            / NULLIF(bpp.total_prescription_amount, 0)::NUMERIC(18, 6)
                        ) * COALESCE(bes.total_directsale_amount, 0)::NUMERIC
                    END
                )::NUMERIC, 2) AS total_distributed_directsale_amount,
                ROUND(SUM(
                    CASE
                        WHEN COALESCE(bpp.total_prescription_amount, 0) = 0 THEN 0
                        ELSE (COALESCE(pr.prescription_qty * p.price, 0)::NUMERIC(18, 6)
                            / NULLIF(bpp.total_prescription_amount, 0)::NUMERIC(18, 6)
                        ) * COALESCE(bes.total_wholesale_amount, 0)::NUMERIC
                    END
                )::NUMERIC, 2) AS total_distributed_wholesale_amount,
                ROUND(SUM(
                    CASE
                        WHEN COALESCE(bpp.total_prescription_amount, 0) = 0 THEN 0
                        ELSE (COALESCE(pr.prescription_qty * p.price, 0)::NUMERIC(18, 6)
                            / NULLIF(bpp.total_prescription_amount, 0)::NUMERIC(18, 6)
                        ) * COALESCE(bes.total_sale_amount, 0)::NUMERIC
                    END
                )::NUMERIC, 2) AS total_distributed_sales_amount
            FROM performance_records_absorption pr
            LEFT JOIN client_pharmacy_assignments cpa ON cpa.client_id = pr.client_id
            LEFT JOIN pharmacies pmc ON pmc.id = cpa.pharmacy_id
            LEFT JOIN products p ON p.id = pr.product_id
            LEFT JOIN based_pharmacy_prescription bpp ON bpp.pharmacy_id = cpa.pharmacy_id
                AND bpp.product_id = pr.product_id
                AND bpp.prescription_month = pr.prescription_month
            LEFT JOIN based_external_sales bes ON bes.sales_date = pr.prescription_month
                AND bes.pharmacy_biz_reg_no = pmc.business_registration_number
                AND bes.insurance_code = bpp.insurance_code
            WHERE pr.settlement_month = p_settlement_month
            GROUP BY pr.id
        )
    UPDATE performance_records_absorption pra
    SET
        wholesale_revenue = COALESCE(cr.total_distributed_wholesale_amount, 0),
        direct_revenue = COALESCE(cr.total_distributed_directsale_amount, 0),
        total_revenue = COALESCE(cr.total_distributed_sales_amount, 0),
        absorption_rate = CASE
            WHEN COALESCE(pra.prescription_qty * p.price, 0) > 0 THEN
                ROUND(COALESCE(cr.total_distributed_sales_amount, 0) / COALESCE(pra.prescription_qty * p.price, 0), 4)
            ELSE 0
        END,
        analysis_time = NOW()
    FROM calculated_results cr,
         products p
    WHERE pra.id = cr.id
        AND pra.product_id = p.id;
    
    RAISE NOTICE '흡수율 분석 완료 (소수점 형태): %월', p_settlement_month;
END;
